@page "/authorization"
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using BlazorCurseach.Models
@using BlazorCurseach.Services
@inject ProtectedSessionStorage protectedSessionStorage
@inject AuthService AuthService
@inject HashService HashService

<div class="autorize-model">

    <h2 class="authorize-title">Please authorize.</h2>

    <EditForm Model="@Client" OnValidSubmit="HandleClientData" FormName="AuthorizeForm">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <label for="login">Login</label>
        <InputText id="login" @bind-Value="Client.login"></InputText><br>
        <label for="password">Password</label>
        <InputText id="password" type="password" @bind-Value="Client.password"></InputText>

        <button class="btn btn-success" id="autorize-button" type="submit" disabled="@isLoading" @onclick="() => EraseMessage()">
        @if(isLoading)
            { <span>Entering...</span> }
        else
            { <span>Enter</span> }
        </button>
    </EditForm>

    @if (!string.IsNullOrEmpty(authErrorMessage))
    {
        <div class="alert alert-danger" id="auth-error">@authErrorMessage</div>
    }
</div>

@code {
    protected Client Client { get; set; } = new();

    protected string authErrorMessage = "";
    protected bool isValid = false;
    protected bool isLoading = false;

    protected async Task SendDataAsync()
    {
        await protectedSessionStorage.SetAsync("CurrentUser", Client);
    }

    protected async Task HandleClientData()
    {
        isLoading = true;

        string hashPassword = HashService.CalculateHashData(Client.password);

        Client.idClient = new Random().Next(1, 10000);
        Client.password = hashPassword;

        List<Client> clientData = new() { Client };

        isValid = await AuthService.CheckValidClientAsync(clientData);
        isLoading = false;

        if(isValid)
            await SendDataAsync();
        else
            authErrorMessage = "Wrong login or password!";
    }

    protected void EraseMessage()
    {
        authErrorMessage = "";
    }
}